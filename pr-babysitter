#!/bin/bash

set -euo pipefail

# GitHub API constants
readonly GITHUB_API_VERSION="2022-11-28"
readonly GITHUB_ACCEPT_HEADER="application/vnd.github+json"
readonly DEFAULT_WAIT_TIME=600  # 10 minutes

# Usage function
usage() {
    echo "Usage: $0 [OPTIONS] <PR_NUMBER> [REPO]"
    echo ""
    echo "Monitor the status of checks for a GitHub PR"
    echo ""
    echo "Options:"
    echo "  -f            Only show failed checks, do not monitor"
    echo "  -w SECONDS    Wait time in seconds between checks (default: 600)"
    echo "  -r MODE       Re-run mode for failed checks:"
    echo "                  ask         - Prompt for re-run option (default)"
    echo "                  check       - Re-run individual check runs"
    echo "                  workflow    - Re-run entire workflow runs"
    echo "                  failed-jobs - Re-run only failed jobs in workflows"
    echo "  -h            Show this help message"
    echo ""
    echo "Arguments:"
    echo "  PR_NUMBER  The pull request number to monitor"
    echo "  REPO       Optional repository in owner/repo format (defaults to current repo)"
    echo ""
    echo "Examples:"
    echo "  $0 123                          # Monitor PR #123 in current repo"
    echo "  $0 123 owner/repo               # Monitor PR #123 in specified repo"
    echo "  $0 -f 123                       # Show only failed checks"
    echo "  $0 -w 300 123                   # Monitor with 5 minute interval"
    echo "  $0 -r workflow 123              # Auto re-run entire workflows"
    echo "  $0 -r failed-jobs -f 123        # Re-run failed jobs, show failed only"
    exit 0
}

get_pr_head_sha() {
    local pr_number="$1"
    local repo="$2"
    gh pr view "$pr_number" ${repo:+--repo "$repo"} --json headRefOid -q '.headRefOid'
}

get_check_runs() {
    local repo="$1"
    local ref="$2"

    gh api \
        -H "Accept: ${GITHUB_ACCEPT_HEADER}" \
        -H "X-GitHub-Api-Version: ${GITHUB_API_VERSION}" \
        "/repos/${repo}/commits/${ref}/check-runs" | \
    jq '[.check_runs[] | {
        id: .id,
        name: .name,
        state: (
            if .status == "queued" then "QUEUED"
            elif .status == "in_progress" then "IN_PROGRESS"
            elif .status == "completed" and .conclusion == "success" then "SUCCESS"
            elif .status == "completed" and .conclusion == "failure" then "FAILURE"
            elif .status == "completed" and .conclusion == "cancelled" then "CANCELED"
            else "UNKNOWN"
            end
        ),
        link: .html_url,
        completedAt: .completed_at,
        checkSuiteId: .check_suite.id,
        appName: (.app.name // ""),
        isGitHubActions: (.app.slug == "github-actions")
    }]'
}

rerun_check() {
    local repo="$1"
    local check_run_id="$2"

    if ! gh api \
        --method POST \
        -H "Accept: ${GITHUB_ACCEPT_HEADER}" \
        -H "X-GitHub-Api-Version: ${GITHUB_API_VERSION}" \
        "/repos/${repo}/check-runs/${check_run_id}/rerequest" >/dev/null 2>&1; then
        echo "    Warning: Failed to re-run check ${check_run_id}" >&2
        return 1
    fi

    return 0
}

get_check_run_details() {
    local repo="$1"
    local check_run_id="$2"

    gh api \
        -H "Accept: ${GITHUB_ACCEPT_HEADER}" \
        -H "X-GitHub-Api-Version: ${GITHUB_API_VERSION}" \
        "/repos/${repo}/check-runs/${check_run_id}" 2>/dev/null || return 1
}

get_workflow_run_id_from_check() {
    local repo="$1"
    local check_run_id="$2"

    # Get check run details and extract workflow run URL
    local details
    details=$(get_check_run_details "$repo" "$check_run_id") || return 1

    # Extract run_id from html_url (format: .../actions/runs/{run_id}/...)
    echo "$details" | jq -r '.html_url' | grep -oP 'runs/\K[0-9]+' | head -1 || return 1
}

rerun_workflow_run() {
    local repo="$1"
    local run_id="$2"

    if ! gh api \
        --method POST \
        -H "Accept: ${GITHUB_ACCEPT_HEADER}" \
        -H "X-GitHub-Api-Version: ${GITHUB_API_VERSION}" \
        "/repos/${repo}/actions/runs/${run_id}/rerun" >/dev/null 2>&1; then
        echo "    Warning: Failed to re-run workflow ${run_id}" >&2
        return 1
    fi

    return 0
}

rerun_failed_jobs() {
    local repo="$1"
    local run_id="$2"

    if ! gh api \
        --method POST \
        -H "Accept: ${GITHUB_ACCEPT_HEADER}" \
        -H "X-GitHub-Api-Version: ${GITHUB_API_VERSION}" \
        "/repos/${repo}/actions/runs/${run_id}/rerun-failed-jobs" >/dev/null 2>&1; then
        echo "    Warning: Failed to re-run failed jobs in workflow ${run_id}" >&2
        return 1
    fi

    return 0
}

render_checks() {
    # '.[] | select(.state != "SUCCESS" and .state != "IN_PROGRESS" and .state != "QUEUED") |
    FILTER="${1:-"true"}"
    cat - | \
    jq -r \
    ".[] | select(${FILTER}) |
        (if .state == \"SUCCESS\" then \"âœ…\"
         elif .state == \"IN_PROGRESS\" then \"ðŸ”µ\"
         elif .state == \"QUEUED\" then \"ðŸ§µ\"
         elif .state == \"FAILURE\" then \"ðŸš¨\"
         elif .state == \"CANCELED\" then \"âœ–ï¸\"
         else \"â“\" end) as \$emoji |
        \"\\(\$emoji) \\(.name) (\\(.id))\\n\\(.link)\""
}

# Check if gh is installed
if ! command -v gh &> /dev/null; then
    echo "Error: gh CLI is not installed. Please install it from https://cli.github.com/"
    exit 1
fi

# Check if jq is installed
if ! command -v jq &> /dev/null; then
    echo "Error: jq is not installed."
    exit 1
fi

# Verify gh authentication
if ! gh auth status >/dev/null 2>&1; then
    echo "Error: gh is not authenticated. Run 'gh auth login' first."
    exit 1
fi

# Default values
WAIT_TIME="${DEFAULT_WAIT_TIME}"
FAILED_ONLY=false
RERUN_MODE="ask"  # ask, check, workflow, failed-jobs

# Parse options
while getopts "fw:r:h" opt; do
    case $opt in
        f)
            FAILED_ONLY=true
            ;;
        w)
            WAIT_TIME="$OPTARG"
            ;;
        r)
            # Validate rerun mode
            case "$OPTARG" in
                check|workflow|failed-jobs|ask)
                    RERUN_MODE="$OPTARG"
                    ;;
                *)
                    echo "Error: Invalid rerun mode. Use: check, workflow, failed-jobs, or ask"
                    exit 1
                    ;;
            esac
            ;;
        h)
            usage
            ;;
        *)
            echo "Error: invalid option: ${opt}"
            exit 1
            ;;
    esac
done
shift $((OPTIND - 1))

# Parse arguments
PR_NUMBER="$1"
REPO="${2:-}"

if [ -z "$PR_NUMBER" ]; then
    usage
fi

# Validate PR_NUMBER is numeric
if ! [[ "$PR_NUMBER" =~ ^[0-9]+$ ]]; then
    echo "Error: PR_NUMBER must be a positive integer"
    exit 1
fi

# If REPO is not provided, try to get it from the current git repository
if [ -z "$REPO" ]; then
    REPO=$(gh repo view --json nameWithOwner -q '.nameWithOwner' 2>/dev/null || echo "")
    if [ -z "$REPO" ]; then
        echo "Error: Could not determine repository. Please specify REPO argument or run from within a git repository."
        exit 1
    fi
fi

# Validate REPO format (owner/repo)
if ! [[ "$REPO" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]; then
    echo "Error: REPO must be in owner/repo format"
    exit 1
fi

# Get the latest commit SHA for the PR
PR_HEAD_SHA=$(get_pr_head_sha "$PR_NUMBER" "$REPO")
if [ -z "$PR_HEAD_SHA" ]; then
    echo "Error: Could not get HEAD SHA for PR #$PR_NUMBER"
    exit 1
fi

# ANSI color codes
WHITE="\033[1;37m"
CYAN="\033[36m"
RESET="\033[0m"

# If failed-only mode, show failed checks and exit
if [ "$FAILED_ONLY" = true ]; then
    CHECKS_JSON=$(get_check_runs "$REPO" "$PR_HEAD_SHA")
    FAILED_CHECKS=$(echo "$CHECKS_JSON" | jq '[.[] | select(.state != "SUCCESS" and .state != "IN_PROGRESS" and .state != "QUEUED")] | length')

    if [ "$FAILED_CHECKS" -eq 0 ]; then
        echo "No failed checks found for PR #$PR_NUMBER"
        exit 0
    fi

    echo "==================================="
    echo "Failed Checks for PR #$PR_NUMBER"
    echo "==================================="
    echo ""
    echo "$CHECKS_JSON" | \
        render_checks '.state != "SUCCESS" and .state != "IN_PROGRESS" and .state != "QUEUED"'
    exit 0
fi

# Monitor checks
echo "Monitoring checks for PR #$PR_NUMBER..."
echo ""

# Common filters
FAILED_CHECK_FILTER=".state != \"SUCCESS\" and .state != \"IN_PROGRESS\" and .state != \"QUEUED\""
RUNNING_CHECK_FILTER=".state == \"IN_PROGRESS\" or .state == \"QUEUED\""

while true; do
    # Clear screen for clean output
    clear

    echo "==================================="
    echo "PR #$PR_NUMBER - Check Status"
    echo "==================================="
    echo ""

    # Get latest commit SHA (in case there are new commits)
    PR_HEAD_SHA=$(get_pr_head_sha "$PR_NUMBER" "$REPO")

    # Get check status
    CHECKS_JSON=$(get_check_runs "$REPO" "$PR_HEAD_SHA")

    # Format and display output
    echo "$CHECKS_JSON" | render_checks

    echo ""
    echo "-----------------------------------"
    echo "Last updated: $(date '+%Y-%m-%d %H:%M:%S')"

    # Check if there are any IN_PROGRESS or QUEUED checks
    ACTIVE_CHECKS=$(echo "$CHECKS_JSON" | jq "[.[] | select(${RUNNING_CHECK_FILTER})] | length")

    if [ "$ACTIVE_CHECKS" -eq 0 ]; then
        # Check if there are any failed or canceled checks
        FAILED_CHECKS=$(echo "$CHECKS_JSON" | jq "[.[] | select(${FAILED_CHECK_FILTER})] | length")

        echo "All checks completed. Monitoring stopped."
        echo "-----------------------------------"

        if [ "$FAILED_CHECKS" -gt 0 ]; then
            echo ""
            echo "There are $FAILED_CHECKS failed check(s)."

            # Determine re-run mode
            rerun_action="$RERUN_MODE"
            if [ "$RERUN_MODE" = "ask" ]; then
                echo ""
                echo "Re-run options:"
                echo "  1) Re-run individual check runs (default)"
                echo "  2) Re-run entire workflow runs (all jobs)"
                echo "  3) Re-run only failed jobs in workflows"
                echo "  n) Skip re-run"
                echo ""
                read -p "Select option (1-3, n): " -n 1 -r
                echo ""

                case $REPLY in
                    1|"")
                        rerun_action="check"
                        ;;
                    2)
                        rerun_action="workflow"
                        ;;
                    3)
                        rerun_action="failed-jobs"
                        ;;
                    [Nn])
                        rerun_action="skip"
                        ;;
                    *)
                        echo "Invalid option. Skipping re-run."
                        rerun_action="skip"
                        ;;
                esac
            fi

            # Execute the selected re-run action
            case $rerun_action in
                check)
                    echo ""
                    echo "Re-running individual check runs..."
                    # Get all failed checks with their IDs and names
                    echo "$CHECKS_JSON" | jq -r "[.[] | select(${FAILED_CHECK_FILTER})] | .[] | \"\(.id)|\(.name)\"" | \
                    while IFS='|' read -r check_id check_name; do
                        echo "  Requesting re-run for: $check_name"
                        rerun_check "$REPO" "$check_id" || true
                    done
                    echo "Done."
                    ;;
                workflow)
                    echo ""
                    echo "Re-running entire workflow runs..."
                    # Get unique workflow run IDs from failed GitHub Actions checks
                    FAILED_GA_CHECKS=$(echo "$CHECKS_JSON" | \
                        jq -r "[.[] | select(${FAILED_CHECK_FILTER}) | select(.isGitHubActions == true)] | unique_by(.checkSuiteId)")

                    if [ "$(echo "$FAILED_GA_CHECKS" | jq 'length')" -eq 0 ]; then
                        echo "  No GitHub Actions workflows to re-run"
                    else
                        echo "$FAILED_GA_CHECKS" | jq -r '.[] | "\(.id)|\(.name)|\(.appName)"' | \
                        while IFS='|' read -r check_id check_name app_name; do
                            echo "  Finding workflow run for: $check_name"
                            run_id=$(get_workflow_run_id_from_check "$REPO" "$check_id")

                            if [ -n "$run_id" ]; then
                                echo "    Re-running workflow run $run_id..."
                                rerun_workflow_run "$REPO" "$run_id" || true
                            else
                                echo "    Warning: Could not find workflow run ID"
                            fi
                        done
                        echo "Done."
                    fi
                    ;;
                failed-jobs)
                    echo ""
                    echo "Re-running only failed jobs in workflows..."
                    # Get unique workflow run IDs from failed GitHub Actions checks
                    FAILED_GA_CHECKS=$(echo "$CHECKS_JSON" | \
                        jq -r "[.[] | select(${FAILED_CHECK_FILTER}) | select(.isGitHubActions == true)] | unique_by(.checkSuiteId)")

                    if [ "$(echo "$FAILED_GA_CHECKS" | jq 'length')" -eq 0 ]; then
                        echo "  No GitHub Actions workflows to re-run"
                    else
                        echo "$FAILED_GA_CHECKS" | jq -r '.[] | "\(.id)|\(.name)|\(.appName)"' | \
                        while IFS='|' read -r check_id check_name app_name; do
                            echo "  Finding workflow run for: $check_name"
                            run_id=$(get_workflow_run_id_from_check "$REPO" "$check_id")

                            if [ -n "$run_id" ]; then
                                echo "    Re-running failed jobs in workflow run $run_id..."
                                rerun_failed_jobs "$REPO" "$run_id" || true
                            else
                                echo "    Warning: Could not find workflow run ID"
                            fi
                        done
                        echo "Done."
                    fi
                    ;;
                skip)
                    echo "Skipping re-run."
                    ;;
                *)
                    echo "Unknown re-run mode: $rerun_action. Skipping."
                    ;;
            esac
        fi
    fi

    echo "Press Ctrl+C to stop monitoring"
    echo "-----------------------------------"

    # Wait before next check
    sleep "$WAIT_TIME"
done
